name: Deploy Enterprise Talent Portal

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    environment:
      name: Development

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # -------------------------
    # FRONTEND BUILD (VITE)
    # -------------------------
    - name: Install Frontend Dependencies
      run: npm install
      working-directory: ./frontend

    - name: Build Frontend
      run: npm run build
      working-directory: ./frontend
      env:
        VITE_USE_COSMOS_DB: '1'
        VITE_COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
        VITE_COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
        VITE_COSMOS_DB_DATABASE_ID: ${{ secrets.COSMOS_DataBase }}
        VITE_COSMOS_DB_CONTAINER_ID: ${{ secrets.COSMOS_Container }}

    # -------------------------
    # BACKEND BUILD (TSC)
    # -------------------------
    - name: Install Backend Dependencies
      run: npm install
      working-directory: ./backend

    - name: Build Backend
      run: npm run build
      working-directory: ./backend

    # -------------------------
    # CREATE DEPLOY PACKAGE
    # -------------------------
    - name: Create Deployment Package
      run: |
        echo "Creating deployment folder..."
        mkdir -p deploy_package

        echo "Copy backend build output..."
        # Ensure server.js exists
        ls -la backend/build

        # Copy compiled backend files to root
        cp backend/build/server.js deploy_package/
        cp -r backend/build/*.js deploy_package/ || true

        echo "Copy package.json..."
        cp backend/package.json deploy_package/

        echo "Create public folder..."
        mkdir -p deploy_package/public

        echo "Copy frontend dist..."
        ls -la frontend/dist
        cp -r frontend/dist/* deploy_package/public/

    # -------------------------
    # INSTALL PROD DEPENDENCIES
    # -------------------------
    - name: Install Production Dependencies
      run: |
        cd deploy_package
        npm install --omit=dev
        ls -la

    # -------------------------
    # FINAL STRUCTURE CHECK
    # -------------------------
    - name: Verify Deployment Structure
      run: |
        echo "Final deploy structure:"
        ls -R deploy_package

    # -------------------------
    # DEPLOY TO AZURE
    # -------------------------
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'lts-employeeskillmatrix'
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ./deploy_package
        startupCommand: 'node server.js'

    - name: Deployment Complete
      run: echo "Deployment to Azure App Service is complete."